<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Prototipo Gacha RPG v28</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .tabs { display: flex; gap: 10px; }
    .tab-btn { padding: 8px 16px; border: none; background: #ddd; cursor: pointer; border-radius: 4px; }
    .tab-btn.active { background: #add8e6; color: #000; }
    #lang-select { padding: 4px 8px; font-size: 16px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    /* Gacha */
    .gacha-container { display: flex; gap: 20px; align-items: flex-start; }
    #gacha-types-menu, #collection-filter-menu { display: flex; flex-direction: column; gap: 10px; }
    .gacha-type-btn, .filter-btn { padding: 6px 12px; border: 1px solid #444; background: #eee; cursor: pointer; border-radius: 4px; }
    .gacha-type-btn.active, .filter-btn.active { background: #add8e6; color: #000; }
    #gacha-section { display: flex; flex-direction: column; align-items: center; }
    #gacha-output { display: grid; grid-template-columns: repeat(2,120px); grid-template-rows: repeat(3,160px); gap:20px; min-height:480px; }
    .card { width:120px; height:160px; position:relative; border:2px solid #444; border-radius:8px; background:#eee; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .card img { width:100%; height:100%; object-fit:contain; border-radius:6px; }
    .badge { position:absolute; top:5px; left:50%; transform:translateX(-50%); background:orange; color:white; font-size:12px; padding:2px 6px; border-radius:4px; }
    #info-text { margin:8px 0; min-height:1.2em; }
    button { padding:8px 16px; margin-top:5px; cursor:pointer; }
    #gacha-btn:not(:disabled), #skip-btn:not(:disabled) { background:orange; color:white; }
    #legend-section { min-width:200px; }
    .legend { border-collapse:collapse; width:100%; }
    .legend th, .legend td { border:1px solid #444; padding:6px 10px; text-align:left; }
    .legend th { background:#555; color:#fff; }
    .legend td.common { color:#cccccc; font-weight:bold; }
    .legend td.rare   { color:#4da6ff; font-weight:bold; }
    .legend td.epic   { color:#bf7fff; font-weight:bold; }
    .legend td.legend { color:#ffcc00; font-weight:bold; }
    /* Colecci칩n */
    .collection-container { display: flex; gap: 20px; align-items: flex-start; }
    .collection-grid { display: grid; grid-template-columns: repeat(5, 120px); gap: 20px; }
    .collection-card { width: 120px; text-align: center; }
    .collection-card .card-img { width: 120px; height: 160px; border: 2px solid #444; border-radius: 8px; overflow: hidden; }
    .collection-card .card-img img { width: 100%; height: 100%; object-fit: contain; border-radius: 6px; }
    .collection-card.uncollected .card-img img { filter: grayscale(100%); }
    .card-name { margin-top: 6px; font-weight: bold; }
    .card-count { margin-top: 4px; font-size: 14px; }
  </style>
</head>
<body>
  <div class="header">
    <div class="tabs">
      <button id="tab-btn-gacha" class="tab-btn active">Gacha</button>
      <button id="tab-btn-collection" class="tab-btn">Colecci칩n</button>
    </div>
    <select id="lang-select">
      <option value="es">游쀯릖 Espa침ol</option>
      <option value="en">游섫릖 English</option>
    </select>
  </div>

  <!-- Pesta침a Gacha -->
  <div id="tab-gacha" class="tab-content active">
    <div class="gacha-container">
      <div id="gacha-types-menu"></div>
      <div id="gacha-section">
        <div id="gacha-output"></div>
        <div id="info-text">Pulsa en cada carta para mostrarlas</div>
        <button id="gacha-btn" disabled>Abrir Sobre</button>
        <button id="skip-btn" disabled>Revelar Todas</button>
      </div>
      <div id="legend-section">
        <table class="legend">
          <thead><tr><th id="hdr-rarity">Rareza</th><th id="hdr-prob">Probabilidad</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pesta침a Colecci칩n -->
  <div id="tab-collection" class="tab-content">
    <div class="collection-container">
      <div id="collection-filter-menu"></div>
      <div id="collection-grid" class="collection-grid"></div>
    </div>
  </div>

<script>
let cards=[], rarities={}, gachas=[], selectedGacha;
let counts={}, totalPacks=0, totalCards=0, currentPack=[], revealedCount=0;

async function loadData(){
  const bust=Date.now();
  [cards, rarities, gachas] = await Promise.all([
    fetch(`data/cards.json?v=${bust}`,{cache:'no-cache'}).then(r=>r.json()),
    fetch(`data/rarities.json?v=${bust}`,{cache:'no-cache'}).then(r=>r.json()),
    fetch(`data/gachas.json?v=${bust}`,{cache:'no-cache'}).then(r=>r.json())
  ]);
  // Inicializar contadores
  cards.forEach(c => counts[c.id] = 0);
  initStats(); initGachaMenu(); initCollection(); bindEvents();
  document.getElementById('gacha-btn').disabled=false;
  updateLanguage('es');
}

function initStats(){
  // No usado en grid
}

function initGachaMenu(){
  const menu=document.getElementById('gacha-types-menu'); menu.innerHTML='';
  gachas.forEach(g=>{
    const btn=document.createElement('button');
    btn.id='gacha-type-'+g.id; btn.className='gacha-type-btn';
    btn.textContent=g.label.es; btn.onclick=()=>selectGacha(g.id);
    menu.appendChild(btn);
  });
  selectGacha(gachas[0].id);
}

function selectGacha(id){
  selectedGacha=gachas.find(g=>g.id===id);
  document.querySelectorAll('.gacha-type-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('gacha-type-'+id).classList.add('active');
  updateLegend();
}

function updateLegend(){
  const tbody=document.querySelector('#legend-section .legend tbody'); tbody.innerHTML='';
  const weights=selectedGacha.weights, total=Object.values(weights).reduce((a,b)=>a+b,0);
  Object.entries(weights).forEach(([key,pts])=>{
    const prob= total?((pts/total)*100).toFixed(1)+'%':'0%';
    tbody.innerHTML+=`<tr><td class="${key}">${rarities[key].label.es}</td><td>${prob}</td></tr>`;
  });
}

function initCollection(){
  const menu=document.getElementById('collection-filter-menu'); menu.innerHTML='';
  // Filtro "Todas"
  const allBtn=document.createElement('button');
  allBtn.className='filter-btn active'; allBtn.textContent='Todas';
  allBtn.onclick=()=>filterCollection('all');
  menu.appendChild(allBtn);
  Object.keys(rarities).forEach(r=>{
    const btn=document.createElement('button');
    btn.className='filter-btn'; btn.textContent=rarities[r].label.es;
    btn.onclick=()=>filterCollection(r);
    menu.appendChild(btn);
  });
  renderCollection();
}

function renderCollection(){
  const grid=document.getElementById('collection-grid'); grid.innerHTML='';
  cards.forEach(c=>{
    const div=document.createElement('div'); div.className='collection-card';
    div.dataset.rarity=c.rarity;
    // Card image
    const imgDiv=document.createElement('div'); imgDiv.className='card-img';
    const img=document.createElement('img'); img.src=c.image; img.alt='Carta '+c.id;
    imgDiv.appendChild(img); div.appendChild(imgDiv);
    // Name
    const nameDiv=document.createElement('div'); nameDiv.className='card-name';
    nameDiv.textContent='Carta '+c.id; div.appendChild(nameDiv);
    // Count
    const countDiv=document.createElement('div'); countDiv.className='card-count';
    countDiv.textContent=counts[c.id]>0?counts[c.id]:'No encontrada';
    if(counts[c.id]===0) div.classList.add('uncollected');
    div.appendChild(countDiv);
    grid.appendChild(div);
  });
}

function filterCollection(rarity){
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  if(rarity==='all') document.querySelector('.filter-btn').classList.add('active');
  else document.querySelector(`#collection-filter-menu .filter-btn:nth-child(${Object.keys(rarities).indexOf(rarity)+2})`).classList.add('active');
  document.querySelectorAll('.collection-card').forEach(card=>{
    card.style.display = (rarity==='all' || card.dataset.rarity===rarity)?'block':'none';
  });
}

// Eventos
function bindEvents(){
  document.getElementById('gacha-btn').addEventListener('click',generatePack);
  document.getElementById('skip-btn').addEventListener('click',()=>document.querySelectorAll('.card:not(.revealed)').forEach(d=>revealCard(d)));
  document.getElementById('lang-select').addEventListener('change',e=>updateLanguage(e.target.value));
  document.getElementById('tab-btn-gacha').addEventListener('click',()=>showTab('gacha'));
  document.getElementById('tab-btn-collection').addEventListener('click',()=>showTab('collection'));
}

function generatePack(){
  totalPacks++; document.getElementById('gacha-btn').disabled=true; revealedCount=0;
  const totalW=Object.values(selectedGacha.weights).reduce((a,b)=>a+b,0);
  const out=document.getElementById('gacha-output'); out.innerHTML='';
  currentPack=Array.from({length:5},()=>{
    let r=Math.random()*totalW,acc=0;
    for(const [key,pts] of Object.entries(selectedGacha.weights)){
      acc+=pts; if(r<acc) return {id:getRandomCardByRarity(key),rarity:key};
    }
    return {id:getRandomCardByRarity('legend'),rarity:'legend'};
  });
  currentPack.forEach((card,i)=>{
    const d=document.createElement('div'); d.className='card'; d.dataset.id=card.id; d.dataset.rarity=card.rarity;
    if(i===2){d.style.gridColumn='1 / span 2'; d.style.justifySelf='center';}
    d.addEventListener('click',()=>revealCard(d)); out.appendChild(d);
  });
  document.getElementById('skip-btn').disabled=false;
}

function revealCard(div){
  if(div.classList.contains('revealed')) return;
  const id=+div.dataset.id, key=div.dataset.rarity;
  div.innerHTML=`<img src="${cards.find(c=>c.id===id).image}" style="width:100%;height:100%;border:4px solid ${rarities[key].color};border-radius:6px;">`;
  const prev=counts[id];
  if(prev===0){
    const b=document.createElement('div'); b.className='badge';
    b.textContent=document.getElementById('lang-select').value==='es'?'Nuevo':'New'; div.appendChild(b);
  }
  div.classList.add('revealed'); revealedCount++; totalCards++;
  counts[id]++; updateCollectionCard(id);
  if(revealedCount===currentPack.length){
    document.getElementById('skip-btn').disabled=true;
    document.getElementById('gacha-btn').disabled=false;
  }
}

function updateCollectionCard(id){
  const cardsEls = document.querySelectorAll('.collection-card');
  cardsEls.forEach(card=>{
    if(card.querySelector('.card-name').textContent.endsWith(id)){
      const countDiv=card.querySelector('.card-count');
      countDiv.textContent=counts[id];
      if(counts[id]>0) card.classList.remove('uncollected');
    }
  });
}

function showTab(tab){
  document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.getElementById('tab-btn-'+tab).classList.add('active');
}

function updateLanguage(lang){
  const t={es:{btnOpen:'Abrir Sobre',skip:'Revelar Todas',info:'Pulsa en cada carta para mostrarlas'},en:{btnOpen:'Open Pack',skip:'Skip',info:'Click each card to show'}}[lang];
  document.getElementById('info-text').textContent=t.info;
  document.getElementById('gacha-btn').textContent=t.btnOpen;
  document.getElementById('skip-btn').textContent=t.skip;
  // actualizar labels
  document.querySelectorAll('.gacha-type-btn').forEach((b,i)=>b.textContent=gachas[i].label[lang]);
  document.querySelectorAll('.filter-btn').forEach((b,i)=>{
    if(i===0) b.textContent= lang==='es'?'Todas':'All';
    else b.textContent=rarities[Object.keys(rarities)[i-1]].label[lang];
  });
}

function getRandomCardByRarity(key){
  const pool=cards.filter(c=>c.rarity===key).map(c=>c.id);
  return pool[Math.floor(Math.random()*pool.length)];
}

document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>