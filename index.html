
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Prototipo Gacha RPG v16</title>
  <style>
    body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; margin: 20px; }
    .container { display: flex; gap: 40px; align-items: flex-start; }
    #stats-section { display: flex; flex-direction: column; gap: 20px; min-width: 360px; }
    #packs-count { font-size: 18px; font-weight: bold; }
    #cards-stats { border-collapse: collapse; width: 100%; font-size: 14px; }
    #cards-stats th, #cards-stats td { border: 1px solid #444; padding: 4px 8px; text-align: left; vertical-align: middle; }
    #cards-stats th { background-color: #555; color: #fff; }
    #cards-stats tbody tr:nth-child(odd) { background-color: #fff; }
    #cards-stats tbody tr:nth-child(even) { background-color: #f2f2f2; }
    .rarity-common { color: #cccccc; font-weight: bold; }
    .rarity-rare   { color: #4da6ff; font-weight: bold; }
    .rarity-epic   { color: #bf7fff; font-weight: bold; }
    .rarity-legend { color: #ffcc00; font-weight: bold; }
    #gacha-section { display: flex; flex-direction: column; align-items: center; }
    #gacha-output { margin-bottom: 10px; display: grid; grid-template-columns: repeat(2, 120px); grid-template-rows: repeat(3, 160px); grid-gap: 20px; justify-content: center; min-height: 480px; }
    .card { width: 120px; height: 160px; border: 2px solid #444; border-radius: 8px; background-color: #eee; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .card img { width: 100%; height: 100%; object-fit: contain; border-radius: 6px; }
    #info-text { min-height: 1.2em; margin: 8px 0; visibility: hidden; font-size: 14px; }
    button { padding: 8px 16px; font-size: 16px; cursor: pointer; margin-top: 5px; }
    .controls { display: flex; flex-direction: column; align-items: center; gap: 10px; }
    #lang-select { padding: 4px 8px; font-size: 16px; cursor: pointer; }
    table.legend { border-collapse: collapse; font-size: 16px; width: 200px; margin-top: 10px; }
    table.legend th, table.legend td { border: 1px solid #444; padding: 6px 10px; text-align: left; }
    table.legend th { background-color: #555555; color: #ffffff; }
    table.legend tbody tr:nth-child(odd) { background-color: #ffffff; }
    table.legend tbody tr:nth-child(even) { background-color: #f2f2f2; }
    table.legend td.common { font-weight: bold; color: #cccccc; }
    table.legend td.rare   { font-weight: bold; color: #4da6ff; }
    table.legend td.epic   { font-weight: bold; color: #bf7fff; }
    table.legend td.legend { font-weight: bold; color: #ffcc00; }
  </style>
</head>
<body>
  <h1>Prototipo Gacha RPG</h1>
  <div class="container">
    <div id="stats-section">
      <div id="packs-count">Sobres abiertos: 0</div>
      <table id="cards-stats">
        <thead><tr><th>Carta</th><th>Imagen</th><th>Rareza</th><th>Cantidad</th><th>%</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="gacha-section">
      <!-- Evento onclick directo para asegurar que siempre funciona -->
      <button id="gacha-btn" onclick="generatePack()">Abrir Sobre</button>
      <button id="skip-btn" disabled>Revelar Todas</button>
      <div id="info-text"></div>
      <div id="gacha-output"></div>
    </div>
    <div class="controls">
      <select id="lang-select"><option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option><option value="en">ðŸ‡¬ðŸ‡§ English</option></select>
      <table class="legend"><thead><tr><th id="hdr-rarity">Rareza</th><th id="hdr-prob">Probabilidad</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
  <script>
    let cards = [], rarities = {}, totalPacks = 0, totalCards = 0, currentPack = [], revealedCount = 0;
    async function loadData() {
      [cards, rarities] = await Promise.all([
        fetch('data/cards.json').then(r => r.json()),
        fetch('data/rarities.json').then(r => r.json())
      ]);
      initStatsTable();
      initRarityLegend();
      bindEvents();
      updateLanguage('es');
    }
    function initStatsTable() {
      const tbody = document.querySelector('#cards-stats tbody'); tbody.innerHTML = '';
      cards.forEach(c => {
        const tr = document.createElement('tr'); tr.id = 'stat-'+c.id;
        tr.innerHTML = `
          <td>${c.id}</td>
          <td><img src="${c.image}" width="40" height="53"></td>
          <td class="rarity-${c.rarity}">${rarities[c.rarity].label.es}</td>
          <td>0</td>
          <td class="percent">0%</td>
        `;
        tbody.appendChild(tr);
      });
    }
    function initRarityLegend() {
      const tbody = document.querySelector('.legend tbody'); tbody.innerHTML = '';
      Object.entries(rarities).forEach(([key,r])=>{
        tbody.innerHTML += `<tr><td class="${key}">${r.label.es}</td><td>${Math.round(r.probability*100)}%</td></tr>`;
      });
    }
    function bindEvents() {
      document.getElementById('skip-btn')
        .addEventListener('click', ()=>document.querySelectorAll('.card:not(.revealed)').forEach(div=>revealCard(div)));
      document.getElementById('lang-select')
        .addEventListener('change', e=>updateLanguage(e.target.value));
    }
    function updateLanguage(lang) {
      const t = {es:{hdrRarity:'Rareza',hdrProb:'Probabilidad',skip:'Revelar Todas',info:'Pulsa en cada carta para mostrarlas',percent:'%'},en:{hdrRarity:'Rarity',hdrProb:'Probability',skip:'Skip',info:'Click each card to show',percent:'%'}}[lang];
      document.getElementById('hdr-rarity').textContent = t.hdrRarity;
      document.getElementById('hdr-prob').textContent = t.hdrProb;
      document.getElementById('skip-btn').textContent = t.skip;
      document.getElementById('info-text').textContent = t.info;
      document.querySelector('#cards-stats th:nth-child(5)').textContent = t.percent;
      document.getElementById('packs-count').textContent = lang==='es'?`Sobres abiertos: ${totalPacks}`:`Packs opened: ${totalPacks}`;
      document.querySelectorAll('#cards-stats tbody tr').forEach(tr=>{
        const id = parseInt(tr.id.split('-')[1]);
        const key = cards.find(c=>c.id===id).rarity;
        tr.children[2].textContent = rarities[key].label[lang];
      });
      const legendTbody = document.querySelector('.legend tbody'); legendTbody.innerHTML = '';
      Object.entries(rarities).forEach(([key,r])=>{
        legendTbody.innerHTML += `<tr><td class="${key}">${r.label[lang]}</td><td>${Math.round(r.probability*100)}%</td></tr>`;
      });
    }
    function getRandomRarity() {
      const r=Math.random(); let acc=0;
      for(const [key,val] of Object.entries(rarities)){
        acc+=val.probability; if(r<acc) return key;
      }
      return 'legend';
    }
    function getRandomCardByRarity(key){
      const pool=cards.filter(c=>c.rarity===key).map(c=>c.id);
      return pool[Math.floor(Math.random()*pool.length)];
    }
    function generatePack(){
      totalPacks++; updateLanguage(document.getElementById('lang-select').value);
      revealedCount=0; const output=document.getElementById('gacha-output'); output.innerHTML='';
      currentPack=Array.from({length:5},()=>{
        const r=getRandomRarity(); return {id:getRandomCardByRarity(r),rarity:r};
      });
      currentPack.forEach((card,i)=>{
        const div=document.createElement('div'); div.className='card'; div.dataset.id=card.id; div.dataset.rarity=card.rarity;
        if(i===2){div.style.gridColumn='1 / span 2';div.style.justifySelf='center';}
        div.addEventListener('click',()=>revealCard(div)); output.appendChild(div);
      });
      document.getElementById('skip-btn').disabled=false;
      document.getElementById('info-text').style.visibility='visible';
    }
    function revealCard(div){
      if(div.classList.contains('revealed')) return;
      const id=parseInt(div.dataset.id),key=div.dataset.rarity;
      div.innerHTML=`<img src="${cards.find(c=>c.id===id).image}" style="border:4px solid ${rarities[key].color};">`;
      div.classList.add('revealed'); revealedCount++; totalCards++;
      const row=document.getElementById('stat-'+id); row.children[3].textContent=parseInt(row.children[3].textContent)+1;
      document.querySelectorAll('#cards-stats tbody tr').forEach(tr=>{
        const cnt=parseInt(tr.children[3].textContent);
        tr.children[4].textContent=(cnt/totalCards*100).toFixed(1)+'%';
      });
    }
    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>
